---
created: 2026-02-19
updated: 2026-02-19
revision: 1.0.0
based_on:
  - path: /mnt/d/Vibe_coding_projects/food-delivery-app/PRPs/branded-restaurant-pwa/02-plan.md
    revision: 1.0.0
  - path: /mnt/d/Vibe_coding_projects/food-delivery-app/PRPs/branded-restaurant-pwa.md
    revision: 1.0.0
  - path: /mnt/d/Vibe_coding_projects/food-delivery-app/PRPs/branded-restaurant-pwa/01-idea.md
    revision: 1.0.0
status: needs_revision
---
# Plan Validation Report: Branded Restaurant PWA

**Validator:** Independent Agent
**Status:** GAPS_FOUND

## Summary

The plan covers the core structural requirements (route creation, manifest handler, schema extension, locale redirect) and correctly follows the PRD's URL pattern and architecture decisions. However, five substantive gaps exist: two acceptance criteria are explicitly unimplemented in the plan (Accept-Language fallback, locale cookie update on language switch), one field constraint is missing from the schema task (slug `unique: true`), one REQ-05 element (back-link) is absent from the BrandedHeader component spec, and the data fetch architecture (server vs. client) is underspecified in a way that could mislead the implementer.

---

## Requirements Coverage

**Covered:** 9/10 requirements (~90%)

---

## Requirements Traceability Matrix

| REQ ID | Requirement | Plan Task(s) | Status |
|--------|-------------|--------------|--------|
| REQ-01 | Branded route `/r/[slug]/[locale]` with own layout omitting nav widgets | Tasks 8, 11 | ✓ COVERED |
| REQ-02 | Locale-redirect `/r/[slug]` — cookie / Accept-Language / fallback "en"; HTTP 307 | Tasks 5, 6 | ⚠️ PARTIAL — Accept-Language not implemented |
| REQ-03 | Dynamic manifest at `/r/[slug]/[locale]/manifest.webmanifest` | Task 9 | ✓ COVERED |
| REQ-04 | 5 new Payload fields | Task 1 | ⚠️ PARTIAL — slug missing `unique: true` |
| REQ-05 | BrandedHeader: logo/name + back-link + language switcher | Task 7 | ⚠️ PARTIAL — back-link absent from component spec |
| REQ-06 | `setRequestLocale()` called in branded layout | Task 8 | ✓ COVERED |
| REQ-07 | Slug-based fetch + existing widgets, zero widget modifications | Tasks 3, 4, 10 | ✓ COVERED |
| REQ-08 | Canonical + meta description + title tags | Task 11 | ✓ COVERED |
| REQ-09 | `notFound()` for missing slug or `brandedEnabled === false` | Tasks 6, 8, 11 | ✓ COVERED |
| REQ-10 | Slug field lookup in restaurant service/query | Task 3 | ✓ COVERED |

---

## Critical Requirements Audit

### Must Have (CR-XX)

| ID | Requirement | Task Mapping | Status |
|----|-------------|--------------|--------|
| CR-01 | manifest `start_url` = `/r/{slug}` (locale-free) | Task 9 | ✓ PASS |
| CR-02 | `/r/[slug]/page.tsx` redirects before any render | Task 6 | ✓ PASS |
| CR-03 | `setRequestLocale()` called BEFORE any translated content | Task 8 | ✓ PASS |
| CR-04 | Branded layout renders NO Navigation/Footer/Sidebar | Task 8 | ✓ PASS |
| CR-05 | Language switcher navigates to `/r/[slug]/[new-locale]` | Task 7 | ✓ PASS |
| CR-06 | `notFound()` when `brandedEnabled === false` or slug not found | Tasks 6, 8, 11 | ✓ PASS |
| CR-07 | Existing `(pages)/[locale]/restaurant/[id]/page.tsx` NOT modified | — (not listed in MODIFY) | ✓ PASS |
| CR-08 | `<link rel="manifest">` in branded layout head | Task 8 | ✓ PASS |

### Must NOT (CN-XX)

| ID | Constraint | Violation Check | Status |
|----|------------|-----------------|--------|
| CN-01 | No query params for locale or mode | Plan uses path segments only | ✓ SATISFIED |
| CN-02 | No locale-first URL (`/[locale]/r/[slug]`) | Plan uses `/r/[slug]/[locale]` | ✓ SATISFIED |
| CN-03 | manifest `start_url` must NOT contain locale | Task 9 sets `/r/{slug}` explicitly | ✓ SATISFIED |
| CN-04 | Must NOT modify existing restaurant page widgets | No widget files listed as MODIFY | ✓ SATISFIED |
| CN-05 | No links to aggregator home or other restaurants in branded layout | BrandedHeader spec shows no such links | ✓ SATISFIED |

### Decision Boundaries (DB-XX)

| ID | Decision | Plan Follows? | Status |
|----|----------|---------------|--------|
| DB-01 | URL pattern `/r/[slug]/[locale]` | Yes | ✓ FOLLOWED |
| DB-02 | `scope: "/"` in manifest | Task 9 sets `"/"` | ✓ FOLLOWED |
| DB-03 | Reuse existing Jotai cart atom | Task 10 uses `atoms.selectedItems` | ✓ FOLLOWED |
| DB-04 | Manifest via Route Handler (not `manifest.ts` special file) | Task 9 is `route.ts` | ✓ FOLLOWED |
| DB-05 | Server fetch: Payload REST API via `fetch()` + React `cache()` | Task 4 | ✓ FOLLOWED — but see Issue #5 |

---

## Acceptance Criteria Coverage

| Story | AC | How Addressed | Status |
|-------|----|--------------|----|
| US-01 | AC-01-1: Title = restaurant name | Task 11 `generateMetadata` | ✓ |
| US-01 | AC-01-2: No aggregator nav | Task 8: layout has only BrandedHeader | ✓ |
| US-01 | AC-01-3: Header shows logo OR name as text | Task 7 shows logo + name | ⚠️ AC says OR (conditional), component always shows both |
| US-01 | AC-01-4: "Powered by Foody7" in footer | Task 8 branded layout footer | ✓ |
| US-01 | AC-01-5: 404 if slug not found or brandedEnabled===false | Tasks 6, 8, 11 | ✓ |
| US-01 | AC-01-6: `<link rel="canonical">` | Task 11 `generateMetadata` | ✓ |
| US-02 | AC-02-1: Manifest correct Content-Type | Task 9 `application/manifest+json` | ✓ |
| US-02 | AC-02-2: Manifest `name` = restaurant name | Task 9 | ✓ |
| US-02 | AC-02-3: Manifest `start_url` = `/r/[slug]` (no locale) | Task 9 | ✓ |
| US-02 | AC-02-4: Manifest `scope` = `"/"` | Task 9 | ✓ |
| US-02 | AC-02-5: Manifest `theme_color` = brandColor or fallback | Task 9 | ✓ |
| US-02 | AC-02-6: Manifest icons 192×192 AND 512×512 | Task 9 fallback `/public/icons/` | ✓ |
| US-02 | AC-02-7: Manifest `display` = `"standalone"` | Task 9 | ✓ |
| US-02 | AC-02-8: Android Chrome install prompt | Infra precondition | ✓ (out of plan scope) |
| US-02 | AC-02-9: iOS `apple-mobile-web-app-capable` present | Task 8 layout head | ✓ |
| US-03 | AC-03-1: Language switcher visible, lists all 5 locales | Task 7 BrandedHeader | ✓ |
| US-03 | AC-03-2: Locale switch → `/r/[slug]/[new-locale]` | Task 7 `router.push('/r/${slug}/${newLocale}')` | ✓ |
| US-03 | AC-03-3: After switch, still on branded page | Follows from AC-03-2 destination | ✓ |
| US-03 | AC-03-4: `NEXT_LOCALE` cookie updated on language switch | **Not described in Task 7** | ✗ GAP |
| US-04 | AC-04-1: "Add to cart" — Jotai atom | Task 10 | ✓ |
| US-04 | AC-04-2: Cart drawer shows identically | Task 10 reuses Cart widget | ✓ |
| US-04 | AC-04-3: Checkout → `/[locale]/bucket` | CartButton unchanged | ✓ |
| US-04 | AC-04-4: Clear-cart modal for different restaurant | Task 10 includes ClearCartModal | ✓ |
| US-05 | AC-05-1: `GET /r/[slug]` → HTTP 307 | Task 6 | ✓ |
| US-05 | AC-05-2: Locale detection: cookie → Accept-Language → fallback "en" | **Accept-Language step absent** | ✗ GAP |
| US-05 | AC-05-3: Invalid locales fall back to "en" | Task 6 validates against locale list | ✓ |

**Coverage:** 20/22 criteria (91%) — 2 explicit gaps (AC-03-4, AC-05-2)

---

## Scope Analysis

### Scope Creep (Tasks without requirement trace)

None. All 11 tasks trace to at least one requirement or PRD decision.

### Missing Coverage (Requirements without tasks)

1. **Accept-Language header fallback** (AC-05-2, REQ-02) — Tasks 5 and 6 both note in their own text that only cookie detection is implemented.
2. **`NEXT_LOCALE` cookie write on language switch** (AC-03-4) — Task 7 uses `router.push()` only; plain `router.push()` to a raw path does not write the next-intl locale cookie.
3. **Slug `unique: true` constraint** — Task 1 lists 5 fields but omits `unique: true` on slug. Without it, Payload CMS allows duplicate slugs.
4. **Back-link in BrandedHeader** (REQ-05 literal: "restaurant logo/name, **back-link**, language switcher") — Task 7 describes logo/name and language switcher only.

---

## Ambiguities and Issues Found

| # | Location | Issue | Severity | Suggested Resolution |
|---|----------|-------|----------|---------------------|
| 1 | Tasks 5 & 6 | **Accept-Language fallback absent.** AC-05-2 requires cookie → `Accept-Language` → `"en"`. Both tasks implement only cookie → `"en"`. | HIGH | Add `req.headers.get("accept-language")` parsing in middleware after cookie check. Match first token against locale list; fall through to `"en"` if no match. |
| 2 | Task 7 (BrandedHeader) | **`NEXT_LOCALE` cookie not written on language switch.** `router.push('/r/${slug}/${newLocale}')` does not set the cookie. AC-03-4 requires cookie update so next PWA launch resumes same locale. | HIGH | Add `document.cookie = \`NEXT_LOCALE=${newLocale}; path=/; max-age=31536000\`` before `router.push()`. |
| 3 | Task 1 (Restaurant Collection) | **Slug field missing `unique: true` and `index: true`.** Without `unique`, two restaurants can share a slug. `getRestaurantBySlug` would return the first match non-deterministically. Without `index`, slug filter queries are full-table scans. | HIGH | Add `unique: true` and `index: true` to the slug field in `Restaurants/index.ts`. |
| 4 | Task 7 (BrandedHeader) | **Back-link missing from component spec.** REQ-05 explicitly lists back-link. Destination is unspecified — if it pushes `/`, violates CN-05 spirit. | MEDIUM | Add back-link to `/${locale}/restaurant/${restaurantId}` (canonical aggregator page). This also serves as a graceful way out of the branded experience. |
| 5 | Tasks 4 & 10 | **Data fetch architecture underspecified.** Task 4 creates a server-side `getRestaurantBySlug` util, but Task 10's `BrandedRestaurantContent` is `"use client"` and fetches content via `useGetRestaurantById()` mutation. Two separate fetches occur (server for 404/metadata, client for content). This matches the existing page pattern but is not explained. | MEDIUM | Add a note in plan: "`getRestaurantBySlug` is used for server-side validation and `generateMetadata` only. Page content is fetched client-side via `useGetRestaurantById()` — consistent with existing pattern at `(pages)/[locale]/restaurant/[id]/page.tsx`." |
| 6 | Task 10 (MenuSidebar) | **MenuSidebar `BackButton` hardcodes `push("/")`.** Reusing unmodified MenuSidebar puts an aggregator home link inside the branded page (borderline CN-05 violation). REQ-07 forbids widget modification. | LOW | Document the trade-off. Accept it (back-to-home is not "link to other restaurants") or omit the `MenuSidebar` on branded page if a `classes="hidden"` prop exists. |
| 7 | Task 9 (Manifest icons) | **`appIcon` accessed as `.appIcon?.url` but type not declared in Task 1.** Task 1 adds `appIcon` as `type: "upload", relationTo: "media"` — consistent, but Task 9 must match `.appIcon?.url` access path. | LOW | In Task 1, explicitly state that `logoImage` and `appIcon` follow the same `type: "upload", relationTo: "media"` pattern as the existing `bannerImage` field. |
| 8 | Task 8 (Branded Layout) | **`getMessages()` call implicit.** Layout uses `NextIntlClientProvider` but `const messages = await getMessages()` is not listed as a step. | LOW | Explicitly add `const messages = await getMessages()` and `<NextIntlClientProvider messages={messages}>` to Task 8 implementation notes. |
| 9 | Task 3 (GraphQL slug filter) | **`where: { slug: { equals: $slug } }` filter only works if slug is indexed.** Without `index: true` on the slug field, this is a full-table scan. REST fallback (`/api/restaurants?where[slug][equals]=...`) works regardless but is also slow without an index. | MEDIUM | Resolved by Action Item #3 (add `index: true` to slug field in Task 1). |

---

## Contradictions

1. **REQ-05 "back-link" vs. CN-05 "no aggregator links"**: If back-link points to `/` (aggregator home) it edges into CN-05 territory. Resolved by pointing to `/[locale]/restaurant/[id]` instead.
2. **Plan Tasks 4 vs. 10 (server vs. client fetch)**: `getRestaurantBySlug` implies server-driven content, but `BrandedRestaurantContent` is `"use client"` and uses a client mutation. Not a contradiction, but requires explicit clarification to avoid implementer confusion.

---

## Idea Alignment Check

- ✓ User value achievable via plan — branded page with standalone PWA install is fully achievable with the proposed structure
- ✓ Research gotcha about `scope vs start_url` — plan correctly uses `scope: "/"` (avoids `/bucket` routing problem)
- ✓ Research gotcha about dynamic manifest — plan uses Route Handler, not `manifest.ts` special file
- ✓ Research gotcha about cart state isolation — plan reuses Jotai atom and includes ClearCartModal
- ✓ Research gotcha about SEO canonical — canonical tag included in Task 11
- ✓ Architecture divergence — idea suggested locale-first; PRD decided locale-last; plan follows PRD correctly

---

## Recommendation

**Decision:** REVISE — targeted fixes to 02-plan.md

**Reason:** All gaps are small, targeted additions to existing tasks. No structural rework is needed. Three HIGH-severity items (Accept-Language, cookie write, slug uniqueness) must be fixed before execution to avoid AC failures or data integrity issues.

---

## Action Items

1. [ ] **Task 5 (Middleware) + Task 6 (Redirect page):** Add `Accept-Language` header fallback after cookie check. Middleware: parse `req.headers.get("accept-language")`, match first token against locale list; fallback to `"en"`. Task 6: replicate same logic using `headers()` from `next/headers`.

2. [ ] **Task 7 (BrandedHeader):** Add `document.cookie = \`NEXT_LOCALE=${newLocale}; path=/; max-age=31536000\`` before `router.push()` to satisfy AC-03-4.

3. [ ] **Task 1 (Restaurant Collection):** Add `unique: true` and `index: true` to the slug field definition.

4. [ ] **Task 7 (BrandedHeader):** Add back-link element pointing to `/${locale}/restaurant/${restaurantId}` (requires passing `restaurantId` prop). Document decision if back-link is intentionally omitted.

5. [ ] **Task 4 + Task 10 (Plan narrative):** Add a clarifying note that `getRestaurantBySlug` is used for server-side validation and `generateMetadata` only; content render is client-side via `useGetRestaurantById()` consistent with the existing restaurant page pattern.

6. [ ] **Task 8 (Branded Layout):** Explicitly add `const messages = await getMessages()` and `<NextIntlClientProvider messages={messages}>` to the implementation notes.

7. [ ] **Task 3 (GraphQL query):** Confirm that `index: true` on slug (from Action Item #3) enables efficient `where: { slug: { equals: $slug } }` filter; or note to use Payload REST API as implemented in Task 4.

---

## Next Step

After applying the 7 action items above to `02-plan.md`:

Run: `/s4-execute /mnt/d/Vibe_coding_projects/food-delivery-app/PRPs/branded-restaurant-pwa/02-plan.md`
