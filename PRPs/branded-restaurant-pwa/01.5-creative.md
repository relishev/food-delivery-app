---
created: 2026-02-19
updated: 2026-02-19
revision: 1.0.0
based_on:
  - path: /mnt/d/Vibe_coding_projects/food-delivery-app/PRPs/branded-restaurant-pwa/01-idea.md
    revision: 1.0.0
status: explored
---
# Creative Exploration: Branded Restaurant PWA

## Idea DNA

```yaml
what: "Per-restaurant focus page at a clean URL, installable as PWA with restaurant branding"
why: >
  Restaurant owners want their own branded app without building tech.
  Their customers want a focused ordering experience, not a competitor aggregator.
who:
  primary: "Restaurant owner (wants branding & own app for customers)"
  secondary: "Restaurant's end-customer (orders food)"
constraints:
  - "Single Next.js 15 App Router deployment — no separate infra per restaurant"
  - "Payload CMS backend — adding fields is straightforward"
  - "Existing Capacitor setup for foody7 app — reuse toolchain"
  - "nginx on kiberos.ai — no wildcard DNS currently"
  - "PWA manifest scope must contain start_url for install prompt to appear"
success_criteria:
  - "Restaurant page is installable as PWA from browser (Android + iOS)"
  - "Branded nav shows restaurant logo/name, hides aggregator nav links"
  - "Existing ordering flow (add dish → cart → checkout) works without changes"
  - "Main aggregator foody7.com unchanged — restaurant still listed there"
  - "URL is human-readable and shareable: foody7.com/en/r/ramen-house"
```

## Research Findings

**Codebase patterns:**
- Existing `(pages)` route group at `src/app/(pages)/[locale]/` with full nav layout
- Restaurant page widgets (`Banner`, `Products`, `Cart`, `MenuSidebar`) are self-contained —
  can be composed in a different layout without changes
- `manifest.json` is currently static in `/public/` — Next.js 15 supports `manifest.ts`
  as a special file at any route segment level
- `capacitor.config.ts` points to `foody7.com` — parameterisable for per-restaurant APK builds
- Jotai cart state in `localStorage` — shared between branded and aggregator pages (intentional)

**Key insight from research:**
PWA `scope` determines which pages stay in "standalone" mode. Three practical scope strategies:
1. `scope: "/"` — whole site stays in standalone → pragmatic, existing `/bucket` page works as-is
2. `scope: "/en/r/[slug]/"` — tight isolation → need branded `/bucket`, `/profile` under `/r/[slug]/`
3. `scope: "/r/"` — all branded restaurants share scope → fine for navigation, simpler manifest

---

## Approaches

### A: Path-based Route Group — `/r/[slug]`  *(Recommended)*

**Description:** Create a `(branded)` Next.js route group with its own layout (stripped nav,
restaurant header). Route: `/[locale]/r/[slug]`. Manifest served from `/r/[slug]/manifest.webmanifest`
with `scope: "/"` so existing `/bucket` page works inside the PWA without rebuilding it.

```
src/app/
├── (pages)/[locale]/          ← existing, unchanged
│   ├── layout.tsx             ← full aggregator nav
│   └── restaurant/[id]/...
└── r/                         ← NEW — outside (pages), restaurant is primary namespace
    └── [slug]/
        ├── page.tsx           ← locale redirect: detect cookie/Accept-Language → /r/[slug]/ko
        └── [locale]/
            ├── layout.tsx     ← branded layout + setRequestLocale(locale)
            ├── manifest.ts    ← dynamic manifest (name, color, icons from DB)
            └── page.tsx       ← load restaurant by slug → render same widgets
```

**URL semantics:** Restaurant is the primary namespace, locale is secondary.
- `/r/ramen-house` → canonical, locale-free (for QR codes, sharing)
- `/r/ramen-house/ko` → Korean branded page
- `/r/ramen-house/en` → English branded page
- Language switcher navigates between `/r/[slug]/ko` ↔ `/r/[slug]/en`

**Scope strategy:** `scope: "/"` + `start_url: "/r/ramen-house"` (locale-free).
- PWA launches at `/r/ramen-house` → redirect to user's locale automatically
- User can navigate to `/bucket` (existing page) — still in PWA standalone
- Logo in branded header links back to `/r/[slug]`, not `/`

**next-intl note:** `r/[slug]/[locale]` is outside next-intl's automatic locale routing.
`layout.tsx` manually calls `setRequestLocale(params.locale)` — standard next-intl pattern
for custom locale routes, fully documented.

**DB additions:** `slug` (unique), `brandColor`, `logoImage`, `appIcon`, `brandedEnabled`

**Pros:**
- Zero infra changes — same deployment, same nginx, same domain
- Native Next.js App Router pattern — no middleware hacks
- `start_url: "/r/ramen-house"` is naturally locale-free — no extra redirect route needed
- Semantically correct: restaurant is the namespace, locale is its property
- QR code / share URL = `/r/ramen-house` — clean, memorable
- Dynamic `manifest.ts` is first-class Next.js 15 feature
- All existing widgets (Banner, Products, Cart) reused as-is
- `scope: "/"` means `/bucket` + `/profile` work inside PWA standalone without changes

**Cons:**
- URL still says `foody7.com` — not `ramenhouse.com`; less "white-label"
- `setRequestLocale()` needed manually in branded layout (vs automatic in `(pages)`)
- Restaurant logo header needs design (new component)

**Complexity:** medium
**Risk:** low
**Best for:** MVP, Phase 1 — production-ready quickly without infra changes

---

### B: Subdomain Routing — `raменhouse.foody7.com`

**Description:** Next.js middleware reads the `Host` header. If subdomain matches a
restaurant slug, render branded layout for that restaurant's menu. Same single deployment,
nginx wildcard: `*.foody7.com → same container`.

```
nginx:
  *.foody7.com → kiberos.ai:3010  (same container)

middleware.ts:
  const host = req.headers.get("host")           // "ramen-house.foody7.com"
  const slug = host.split(".foody7.com")[0]       // "ramen-house"
  if (slug && slug !== "www") {
    req.nextUrl.pathname = `/en/r-subdomain/${slug}${pathname}`
    return NextResponse.rewrite(req.nextUrl)
  }

Manifest served at: https://ramen-house.foody7.com/manifest.webmanifest
scope: "/"  (relative to subdomain origin — perfectly isolated!)
```

**Pros:**
- True white-label feel: URL bar shows `ramen-house.foody7.com`
- `scope: "/"` on the subdomain = completely isolated PWA from main foody7
- Each subdomain can have its own Google Play APK without path-based appId tricks
- Looks like a dedicated app to restaurant customers
- Can even map custom domains: `raменhouse.com → CNAME → foody7.com` (Phase 3)

**Cons:**
- Requires nginx wildcard config change: `server_name *.foody7.com`
- Requires wildcard SSL cert for `*.foody7.com` (Let's Encrypt supports this via DNS challenge)
- Middleware runs on every request — performance cost
- Subdomain routing in Next.js requires careful `next-intl` middleware integration
  (currently middleware.ts is from next-intl, needs merging)
- Staging/dev env needs `*.foody7.dev` wildcard too
- More complex to debug (host-based routing vs path-based)

**Complexity:** high
**Risk:** medium
**Best for:** Phase 2/3 when restaurant count grows and white-label feel is a selling point

---

### C: Query Param Embedded Mode — `/restaurant/[id]?app=1`

**Description:** The existing restaurant page detects `?app=1` in the URL. A client-side
`useSearchParams()` hook hides the main nav/footer and shows a minimal branded header.
Manifest served from `/api/manifest?restaurant=[id]` (custom API route).

```tsx
// In restaurant/[id]/page.tsx or layout.tsx
const searchParams = useSearchParams()
const isAppMode = searchParams.get("app") === "1"
```

**PWA manifest approach:**
```
/api/manifest?restaurant=ramen-house
→ Content-Type: application/manifest+json
→ { "start_url": "/en/restaurant/abc123?app=1", "scope": "/" }
```

Link in restaurant page for install: `<link rel="manifest" href="/api/manifest?restaurant=..."/>`

**Pros:**
- Literally 1-2 days to implement
- Zero routing changes — same page, conditional rendering
- Works immediately with existing Capacitor (just change `server.url` to `?app=1`)
- No DB schema changes needed (can derive from existing ID)

**Cons:**
- `start_url` with query params is unreliable for PWA install on some browsers (Chrome may strip params)
- URL not branded: `/restaurant/abc-uuid?app=1` — ugly for QR codes
- No human-readable slug in URL
- Client-side `useSearchParams()` causes flash of aggregator nav before JS hides it
- Not SSR-friendly — nav visible on initial paint
- Chrome's PWA install heuristic: having query params in `start_url` reduces install reliability
- Scope must be `/` — user can navigate to main foody7 page easily

**Complexity:** low
**Risk:** high (PWA manifest reliability, UX flash, no slug)
**Best for:** Emergency prototype only — not recommended for production

---

## Comparison

| Criteria | A: Route Group | B: Subdomain | C: Query Param |
|---|---|---|---|
| Complexity | medium | high | low |
| Time estimate | 3-4 days | 1-2 weeks | 1-2 days |
| Infra changes | none | nginx + SSL wildcard | none |
| URL quality | `foody7.com/r/ramen-house` | `ramen-house.foody7.com` | `foody7.com/restaurant/id?app=1` |
| PWA reliability | ✅ high | ✅ high | ⚠️ medium |
| SSR-correct (no flash) | ✅ yes | ✅ yes | ❌ client-side only |
| `/bucket` works in PWA | ✅ scope="/" | ✅ isolated | ✅ scope="/" |
| Maintainability | high | medium | low |
| Fits codebase patterns | ✅ native App Router | ⚠️ middleware override | ⚠️ hack |
| Phase 2 Capacitor APK | easy | easy | possible |
| Custom domain support | ❌ no (phase 3 only) | ✅ yes (CNAME) | ❌ no |
| Risk | low | medium | high |

---

## Recommendation

**Selected:** Approach A — Path-based Route Group (`/r/[slug]`)

**Justification:** Fits perfectly into existing Next.js 15 App Router patterns without any
infrastructure changes. The `(branded)` route group gives layout isolation natively, SSR works
correctly (no flash), and `manifest.ts` is a first-class Next.js feature at exactly this route
level. `scope: "/"` solves the `/bucket` navigation problem cleanly. The URL
`foody7.com/en/r/ramen-house` is readable, shareable, and QR-code friendly.

**Trade-offs accepted:**
- URL bar shows `foody7.com` (not a dedicated subdomain) — acceptable for Phase 1;
  subdomain can be layered on top in Phase 2 by adding middleware that rewrites
  `ramen-house.foody7.com` → `/en/r/ramen-house` (A + B combined)
- `scope: "/"` means technically user could navigate to aggregator from within PWA via direct URL —
  not a critical issue, and can be addressed with a branded "return to [Restaurant]" button in layout

**Trade-offs NOT accepted:**
- Approach C is rejected — PWA install reliability with query params is a known fragile pattern;
  the UX flash is unacceptable for a branded product

---

## Key Decisions for PRD

1. **URL structure:** `/r/[slug]/[locale]` — restaurant is the primary namespace, locale is
   secondary. `/r/ramen-house` is the canonical shareable URL (redirects to detected locale).
   `slug` stored in Restaurant model, required, unique.
2. **Manifest scope:** `scope: "/"` with `start_url: "/r/[slug]"` (locale-free) — the
   locale-redirect page at `r/[slug]/page.tsx` handles detection via cookie/Accept-Language.
   Language changes navigate between `/r/[slug]/en` ↔ `/r/[slug]/ko` — all within scope.
3. **Branded layout content:** Restaurant logo (if set) + name; "← Menu" back link; no aggregator nav;
   "Powered by Foody7" in footer (small, below fold)
4. **Cart behavior:** Reuse existing Jotai `selectedItems` — user sees clear-cart dialog if switching
   from a different restaurant; no changes needed to cart logic
5. **DB fields:** `slug` (required, unique), `brandColor` (optional hex), `logoImage` (optional media),
   `appIcon` (optional media, 512×512), `brandedEnabled` (boolean, default false)
6. **Admin UX:** "Get branded link" button in Payload admin for enabled restaurants; shows
   QR code + URL + PWA install instructions
7. **Phase 2 (Capacitor APK):** Defer — implement as `foody-ctl build-restaurant-app --slug X`
   script after Phase 1 is live and tested
8. **next-intl scope:** Route group `(branded)` must include `[locale]` segment same as `(pages)`;
   next-intl's middleware already handles this transparently
9. **SEO:** `<link rel="canonical" href="/[locale]/restaurant/[id]" />` on branded page to prevent
   duplicate content indexing

---

**Next:** `/s2-prd /mnt/d/Vibe_coding_projects/food-delivery-app/PRPs/branded-restaurant-pwa/01.5-creative.md`
